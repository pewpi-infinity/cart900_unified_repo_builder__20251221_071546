<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Φ Phi Singer — Golden Ratio Sonification</title>

<style>
body{
  background:#0e0e11;color:#f2f2f2;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  text-align:center;padding:28px
}
h1{font-size:42px;margin:0 0 10px;font-weight:800}
p{opacity:.85;max-width:760px;margin:0 auto 18px}
.row{display:flex;gap:12px;justify-content:center;margin-top:14px}
button{
  font-size:18px;padding:12px 22px;border-radius:12px;
  border:0;cursor:pointer;font-weight:800
}
#play{background:linear-gradient(135deg,#d4af37,#f5d76e);color:#000}
#stop{background:#2a2a33;color:#fff;border:1px solid #3a3a44}
button:disabled{opacity:.55}
.card{
  background:#15151a;border:1px solid #24242b;
  border-radius:14px;padding:16px;max-width:820px;margin:16px auto
}
label{display:block;margin-top:12px;opacity:.85}
input[type=range]{width:min(560px,92vw)}
.small{font-size:12px;opacity:.75}
.mono{font-family:ui-monospace,monospace;font-size:12px;opacity:.8}
</style>
</head>

<body>

<h1>Φ Phi Singer</h1>
<p>Golden Ratio digits → sound. Android-safe audio engine.  
Tempo and volume are now **actually wired**.</p>

<div class="row">
  <button id="play">▶ Play Φ</button>
  <button id="stop" disabled>⏹ Stop</button>
</div>

<div class="card">
  <label>Tempo (ms per note)</label>
  <input id="tempo" type="range" min="80" max="600" value="260">
  <div class="small"><span id="tempoVal">260</span> ms</div>

  <label>Volume</label>
  <input id="vol" type="range" min="1" max="100" value="30">
  <div class="small"><span id="volVal">30</span>%</div>

  <div class="small" id="status">Ready.</div>
  <div class="mono" id="state"></div>
</div>

<script>
/* φ digits */
const phi =
"1618033988749894848204586834365638117720309179805762862135448622705260462818902449707207204189391137";

/* digit → frequency */
const scale=[261.63,293.66,329.63,349.23,392,440,493.88,523.25,587.33,659.25];

let ctx, osc, gain;
let playing=false, stop=false;

const status=document.getElementById("status");
const state=document.getElementById("state");

/* helpers */
const sleep = ms => new Promise(r=>setTimeout(r,ms));

function setupAudio(){
  if(ctx) return;
  ctx=new (window.AudioContext||window.webkitAudioContext)();
  gain=ctx.createGain();
  gain.gain.value=0.00001;
  gain.connect(ctx.destination);

  osc=ctx.createOscillator();
  osc.type="sine";
  osc.frequency.value=440;
  osc.connect(gain);
  osc.start();
}

async function resumeAudio(){
  if(ctx.state==="suspended") await ctx.resume();
  state.textContent="AudioContext: "+ctx.state;
}

/* audible unlock */
async function unlock(){
  const t=ctx.currentTime;
  osc.frequency.setValueAtTime(660,t);
  gain.gain.setValueAtTime(0.00001,t);
  gain.gain.exponentialRampToValueAtTime(0.15,t+0.01);
  gain.gain.exponentialRampToValueAtTime(0.00001,t+0.12);
  await sleep(140);
}

async function play(){
  if(playing) return;
  playing=true; stop=false;
  document.getElementById("play").disabled=true;
  document.getElementById("stop").disabled=false;

  setupAudio();
  await resumeAudio();
  if(ctx.state!=="running"){
    status.textContent="Audio blocked";
    playing=false; return;
  }

  status.textContent="Unlocking…";
  await unlock();

  status.textContent="Playing φ…";

  for(let i=0;i<phi.length;i++){
    if(stop) break;

    const tempoMs=+tempo.value;
    const volPct=+vol.value;
    const vol=Math.max(0.01,volPct/100);

    const d=phi.charCodeAt(i)-48;
    const freq=scale[d]||261.63;

    const now=ctx.currentTime;
    osc.frequency.setValueAtTime(freq,now);

    gain.gain.cancelScheduledValues(now);
    gain.gain.setValueAtTime(0.00001,now);
    gain.gain.exponentialRampToValueAtTime(vol,now+0.01);
    gain.gain.exponentialRampToValueAtTime(
      0.00001,
      now+(tempoMs/1000)*0.9
    );

    await sleep(tempoMs);
  }

  status.textContent=stop?"Stopped.":"Finished.";
  playing=false;
  document.getElementById("play").disabled=false;
  document.getElementById("stop").disabled=true;
}

function stopPlay(){
  stop=true;
  status.textContent="Stopping…";
}

/* UI */
playBtn.addEventListener("pointerdown",e=>{e.preventDefault();play()});
stopBtn.addEventListener("pointerdown",e=>{e.preventDefault();stopPlay()});

tempo.oninput=()=>tempoVal.textContent=tempo.value;
vol.oninput=()=>volVal.textContent=vol.value;
</script>

</body>
</html>

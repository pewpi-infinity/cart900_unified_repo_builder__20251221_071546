<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Φ Phi Singer — Golden Ratio Sonification</title>
  <style>
    body{background:#0e0e11;color:#f2f2f2;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;text-align:center;padding:32px}
    h1{margin:0 0 10px;font-weight:800;font-size:42px}
    p{opacity:.85;max-width:760px;margin:0 auto 18px;line-height:1.35}
    .row{display:flex;gap:12px;justify-content:center;flex-wrap:wrap;margin-top:14px}
    button{font-size:18px;padding:12px 20px;border-radius:12px;border:0;cursor:pointer;font-weight:800}
    #playBtn{background:linear-gradient(135deg,#d4af37,#f5d76e);color:#000}
    #stopBtn{background:#2a2a33;color:#fff;border:1px solid #3a3a44}
    button:disabled{opacity:.55;cursor:not-allowed}
    .card{background:#15151a;border:1px solid #24242b;border-radius:14px;padding:14px;max-width:820px;margin:16px auto 0}
    label{display:block;opacity:.85;margin:10px 0 6px}
    input[type="range"]{width:min(560px,92vw)}
    .mini{opacity:.7;font-size:12px;margin-top:8px}
    .status{opacity:.85;font-size:14px;margin-top:10px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:12px;opacity:.8;word-break:break-word}
  </style>
</head>
<body>

  <h1>Φ Phi Singer</h1>
  <p>Golden Ratio digits → notes (Pi Singer style). Built for Android: async resume + audible unlock + single-oscillator engine.</p>

  <div class="row">
    <button id="playBtn">▶ Play Φ</button>
    <button id="stopBtn" disabled>⏹ Stop</button>
  </div>

  <div class="card">
    <label for="tempo">Tempo (ms per note)</label>
    <input id="tempo" type="range" min="80" max="600" value="260" />
    <div class="mini"><span id="tempoVal">260</span> ms per note</div>

    <label for="gain">Volume</label>
    <input id="gain" type="range" min="1" max="100" value="30" />
    <div class="mini"><span id="gainVal">30</span>%</div>

    <div class="status" id="status">Ready.</div>
    <div class="mono" id="debug"></div>
  </div>

<script>
/* =========================
   φ digits (start segment)
   ========================= */
const phiDigits = (
  "1618033988749894848204586834365638117720309179805762862135448622705260462818902449707207204189391137" +
  "4847540880753868917521266338622235369317931800607667263544333890865959" +
  "3958290563832266131992829026788067520876689250171169620703222104321626" +
  "9548626296313614438149758701220340805887954454749246185695364864449241"
);

/* Digit -> frequency (Pi Singer-ish) */
const scale = [
  261.63, // 0 C4
  293.66, // 1 D4
  329.63, // 2 E4
  349.23, // 3 F4
  392.00, // 4 G4
  440.00, // 5 A4
  493.88, // 6 B4
  523.25, // 7 C5
  587.33, // 8 D5
  659.25  // 9 E5
];

let ctx = null;
let osc = null;
let gainNode = null;
let master = null;

let playing = false;
let stopRequested = false;

const statusEl = document.getElementById("status");
const debugEl = document.getElementById("debug");

function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

/* Force-create audio graph INSIDE gesture */
function createGraphIfNeeded(){
  if (ctx) return;

  ctx = new (window.AudioContext || window.webkitAudioContext)({ latencyHint: "interactive" });

  master = ctx.createGain();
  master.gain.value = 1.0;
  master.connect(ctx.destination);

  gainNode = ctx.createGain();
  gainNode.gain.value = 0.00001; // start silent
  gainNode.connect(master);

  osc = ctx.createOscillator();
  osc.type = "sine";
  osc.frequency.value = 440;
  osc.connect(gainNode);
  osc.start();
}

/* Resume with timeout; if stuck, rebuild once */
async function resumeContextHard(){
  if (!ctx) return;

  const resumeOnce = async () => {
    if (ctx.state === "suspended") {
      await ctx.resume();
    }
  };

  // Try resume with a timeout so we don't hang forever on “Starting audio…”
  const timed = async (ms) => {
    let done = false;
    const t = sleep(ms).then(() => { if (!done) throw new Error("resume-timeout"); });
    const r = resumeOnce().then(() => { done = true; });
    await Promise.race([t, r]);
  };

  try {
    await timed(1200);
  } catch (e) {
    // Rebuild context once if resume hangs
    debugEl.textContent = "Resume stuck — rebuilding audio context once…";
    try { ctx.close && ctx.close(); } catch {}
    ctx = null; osc = null; gainNode = null; master = null;

    createGraphIfNeeded();
    await timed(1200);
  }

  debugEl.textContent = `AudioContext state: ${ctx.state}`;
}

/* Audible unlock beep (you should HEAR this immediately if audio is working) */
async function audibleUnlockBeep(){
  // quick 100ms beep
  const now = ctx.currentTime;
  osc.frequency.setValueAtTime(660, now);
  gainNode.gain.setValueAtTime(0.00001, now);
  gainNode.gain.exponentialRampToValueAtTime(0.18, now + 0.01);
  gainNode.gain.exponentialRampToValueAtTime(0.00001, now + 0.10);
  await sleep(140);
}

/* Play digits using ONE oscillator */
async function playPhi(){
  if (playing) return;
  playing = true;
  stopRequested = false;

  document.getElementById("playBtn").disabled = true;
  document.getElementById("stopBtn").disabled = false;

  try {
    statusEl.textContent = "Starting audio…";
    debugEl.textContent = "";

    createGraphIfNeeded();
    await resumeContextHard();

    // If it’s still not running, stop here with a clear message.
    if (ctx.state !== "running") {
      statusEl.textContent = "Audio blocked by browser/device.";
      debugEl.textContent = `Blocked: state=${ctx.state}. Check phone MEDIA volume + site not muted.`;
      return;
    }

    // Audible unlock test
    statusEl.textContent = "Unlock test beep…";
    await audibleUnlockBeep();

    const tempoMs = Number(document.getElementById("tempo").value);
    const volPct = Number(document.getElementById("gain").value);
    const vol = Math.max(0.01, Math.min(0.30, volPct / 100)); // clamp safe

    statusEl.textContent = "Playing φ…";

    for (let i = 0; i < phiDigits.length; i++){
      if (stopRequested) break;

      const d = phiDigits.charCodeAt(i) - 48;
      const freq = scale[d] || 261.63;

      const now = ctx.currentTime;
      osc.frequency.setValueAtTime(freq, now);

      // “pluck” envelope per note
      gainNode.gain.cancelScheduledValues(now);
      gainNode.gain.setValueAtTime(0.00001, now);
      gainNode.gain.exponentialRampToValueAtTime(vol, now + 0.01);
      gainNode.gain.exponentialRampToValueAtTime(0.00001, now + (tempoMs/1000) * 0.85);

      await sleep(tempoMs);
    }

    statusEl.textContent = stopRequested ? "Stopped." : "Finished.";
  } catch (err) {
    statusEl.textContent = "Audio failed to start.";
    debugEl.textContent = String(err && err.message ? err.message : err);
  } finally {
    playing = false;
    document.getElementById("playBtn").disabled = false;
    document.getElementById("stopBtn").disabled = true;
  }
}

function stopPhi(){
  stopRequested = true;
  statusEl.textContent = "Stopping…";
}

/* Hook events: pointerdown + click for maximum Android compatibility */
const playBtn = document.getElementById("playBtn");
const stopBtn = document.getElementById("stopBtn");

playBtn.addEventListener("pointerdown", (e)=>{ e.preventDefault(); playPhi(); }, {passive:false});
playBtn.addEventListener("click", ()=> playPhi());

stopBtn.addEventListener("pointerdown", (e)=>{ e.preventDefault(); stopPhi(); }, {passive:false});
stopBtn.addEventListener("click", ()=> stopPhi());

/* Slider labels */
const tempo = document.getElementById("tempo");
const tempoVal = document.getElementById("tempoVal");
tempo.addEventListener("input", ()=> tempoVal.textContent = tempo.value);

const gain = document.getElementById("gain");
const gainVal = document.getElementById("gainVal");
gain.addEventListener("input", ()=> gainVal.textContent = gain.value);
</script>

</body>
</html>
